# Ки Джефферис

_**Monero и многое другое - реализация второго уровня и инфраструктуры доказательства доли владения на базе протокола CryptoNote**_

[https://youtu.be/Lkh0CCN9UBQ](https://youtu.be/Lkh0CCN9UBQ)

---

_**Модератор:**_ Следующим выступит Ки Джефферис из проекта Oxen, который расскажет нам о Monero и многом другом.

_**Ки:**_ Привет! Я рад присутствовать здесь, на этой конференции. Да, это было просто захватывающее выступление. Я даже немного возбудился. Поэтому моя часть, вероятно, покажется куда менее интересной. Просто предупреждаю.

Немного о себе. Я являюсь техническим директором Oxen и, соответственно, Session и Lokinet - всего того, над чем мы работаем. Проект был запущен в 2018 или начале 2019 года. Так что мы работаем в этом пространстве уже давно. В 2019 году мы реализовали форк Monero - форк кода, но не форк блокчейна, и, пожалуй, являемся одним из наиболее активно развивающихся форков Monero. Думаю, сейчас нами уже написано около 6000 или 7000 строк кода. Точнее, не строк кода, а коммитов, появившихся после форка. И многое из того, что мы создали в Oxen, по крайней мере, некоторые из тех вещей, которые мы создали в Oxen, затем также слились обратно с ветвями Monero. Заметным вкладом стала поддержка IPv6. Нами также реализованы приложения второго уровня, с которыми большинство из вас уже знакомо. И эти приложения ежемесячно насчитывают уже примерно 600 000 активных пользователей. То есть, нами уже была проделана неплохая работа.

Причина, которая подвигла меня на это выступление, заключается в том, что после нашего форка Monero 2018 года мы потратили много времени на разработку инфраструктуры для реализации приложений первого уровня. Нами были реализованы мгновенные транзакции, контрольные точки, а также мы перешли к использованию в нашей сети доказательства доли владения. Так что, рассказывая об этом, мы предлагаем сообществу Monero модель, которую можно было бы перенять, если сообщество реши двигаться в этом направлении. Я знаю, что доказательство доли не пользуется большой поддержкой, но считаю, это важно, чтобы проекты, которые пошли по этому пути, хотя бы чётко объяснили, почему они это сделали. Так что, мы поговорим о втором уровне, о том, как создавать все эти вещи на базе CryptoNote, а также о других наших приложениях.

Почему мы прежде всего решили заняться вторым уровнем? Почему мы пошли по этому пути? Прежде всего, это произошло не совсем по традиционным причинам, связанным с масштабированием. В случае со многими блокчейнами второй уровень создаётся, чтобы обеспечить возможность, скажем, проведения миллиона транзакций в секунду или с какой-то иной благой целью. Но мы занялись этим по другой причине. Мы хотели разрабатывать приложения. Мы видели такие приложения, как Signal и Tor, и думали, как бы создать устойчивую к атакам Сибиллы или децентрализованную сеть, в которой можно было бы использовать некоторые из этих приложений? Так и появился проект Oxen. А ещё мы хотели улучшить первый уровень. В 2018 году мы обратили внимание на такие монеты, как Dash, которые использовали этот, по сути, основной уровень, чтобы вернуть соответствующие качества на первый уровень. И именно поэтому мы решили заняться этим.

Что нам для этого требовалось? Итак, первым шагом стало решение вопроса с доказательством доли владения и вознаграждением. Это базовый аспект любого создаваемого второго уровня. А затем, на втором уровне, реализуется сетевая инфраструктура. То есть создаются некоторые ресурсы, которые могут быть задействованы сетью. Это могут быть средства, обеспечивающие пропускную способность, вычислительные ресурсы. Я ещё расскажу об этом немного подробнее. А также требуются сетевые политики, гарантирующие, что ресурсы, предоставляемые сети, соответствуют определённым стандартам.

Итак, как мы всё построили? Первая проблема, с которой мы столкнулись - реализация доказательства доли поверх CryptoNote. Очевидно, всё должно происходить приватно. Но при этом вам необходимо иметь возможность проверки проводимых транзакций. Поэтому нам было нужно найти способ блокировки монет, а также способ связать эти монеты с конкретным лицом. Поэтому наш первый подход заключался в использовании выходов с временной блокировкой. В Monero есть функция под названием «время разблокировки», позволяющая отправить транзакцию, в которой выходы будут заблокированы на произвольный период времени. Вы можете заблокировать их на 30 дней, а можете на миллионы лет или на какой-то иной срок.

По сути, первый подход заключался в том, что пользователь отправлял транзакцию самому себе на сумму, соответствующую доле, которая требовалась для участия в блокчейне, и блокировал её на 30 дней. Кроме того, в дополнительном поле транзакции раскрывался ключ транзакции, что позволяло любому пользователю прочитать блокчейн и определить сумму  соответствующей доли. Эта модель немного отличается от той, что была представлена ранее в случае с доказательством доли, построенным поверх CryptoNote. Да, теперь любой может просмотреть блокчейн и убедиться, что человек обладает необходимой долей.

Также требовался способ связать монеты с конкретным лицом. Поэтому мы поместили в дополнительное поле транзакции сгенерированный с помощью Ed25519 ключ, позволяющий вне блокчейна установить связь подписи с определённой долей.

Это была первая версия. И она была далеко не идеальной, поскольку, по сути, вам приходилось повторно подтверждать долю владения каждые 30 дней. То есть, доля подтверждалась в сети, потом срок действия ключа истекал, и приходилось повторять процедуру. У нас было программное обеспечение, которое делало это автоматически, но при этом ключи хранились в памяти, что не очень-то хорошо. Кроме того, при использовании функции разблокировки по умолчанию в случае проведения транзакции блокируется и возвращаемая назад сдача. Поэтому нам пришлось выработать несколько интересных стратегий управления выходами, чтобы пользователь смог забрать сдачу непосредственно перед блокировкой монеты. В противном случае сдача бы блокировалась, что, очевидно, также было бы не очень хорошо.

И вместо этого нами был рассмотрен второй подход: а что если использовать образы ключей? Ведь образы ключей, по сути, защищают от возможности двойной траты, идентифицируя уникальную часть транзакции. Поэтому мы сделали следующее: пользователь отправлял транзакцию самому себе, в этой транзакции была сумма, соответствующая доле, которую он также отправлял самому себе. Затем транзакция, ключ и дополнительное поле транзакции раскрывались. И на основе всей этой информации можно было рассчитать будущий образ ключа, который получится в результате траты этих выходов. А затем сеть может прийти к консенсусу относительно блокировки этих образов ключей. Таким образом, если мы видим транзакцию с соответствующим образом ключа, мы просто не позволяем потратить её выходы в сети. И таким образом можно прийти к консенсусу.

Положительные свойства... но, да, это также влияет на приватность. Важно отметить, что ваши транзакции будут отличаться от обычных транзакций в сети. Поэтому в идеале вы не должны использовать входы этих транзакций при создании других кольцевых подписей. Вы просто можете составить свой чёрный список.

Но это обеспечивает некоторые действительно положительные свойства. Например, это даёт возможность создавать бесконечные доказательства доли. То есть если кто-то подтвердил долю владения, ему уже не придётся делать это повторную. Доказательство будет действовать вечно, пока пользователь не решит покинуть сеть. Также это позволяет создать что-то вроде простой системы штрафов. В Oxen, как правило, это делается следующим образом: если ваш узел не работает с должной производительностью, мы можем занести принадлежащий ему образ ключа в чёрный список и не использовать в течение определённого времени. А это означает издержки, связанные с упущенными возможностями. Также, если захотим, мы можем задействовать слэшинг, запретив использовать такой образ ключа в принципе.

Следующий аспект - вознаграждения. Здесь всё довольно просто. Вы можете просто взять coinbase-транзакцию и разделить вознаграждение. Изначально было сделано так, чтобы часть вознаграждения получали майнеры, а часть - узлы сети. Самый простой способ состоял в том, чтобы составить упорядоченный список узлов, чтобы узел, достигший вершины списка, получал средства, после чего перемещался бы в конец списка, и данный процесс повторялся бы снова и снова. Примерно так всё и происходит в Ethereum.

Что мы имеем сейчас? Как и в случае с теми двумя вещами, о которых я говорил, существует базовая система подтверждения доли, в рамках которой участники получают вознаграждение. Но чего у нас пока ещё нет, так это того, что у тех, кто подтверждает долю, нет никакой цели, кроме простого блокирования средств. Они не участвуют в консенсусе. Пока что мы не создали второго уровня. Поэтому нам нужно добавить ко всему этому ещё что-то.

Что же нам нужно добавить? Подтверждающие долю владения должны поддерживать сеть, то сеть, сетевую инфраструктуру. Как правило, это VPS или какая-то другая серверная инфраструктура. И эта инфраструктура должна обеспечивать возможность взаимодействия, чтобы мы могли делать с её помощью всякие интересные вещи. Также у нас должна быть возможность удалить ту часть инфраструктуры, которая не соответствует заданному уровню.

Так что же это за инфраструктура? Обычно речь идёт о вычислительных ресурсах, сетевых ресурсах и ресурсах, связанных с хранением данных. Обладая всем этим, вы можете децентрализовано построить большинство приложений. Кроме того, тот, кто подтверждает долю, должен быть доступен в сети. Поэтому он должен зарегистрировать IP-адрес и порт, через который с ним можно связаться, а также отвечать на запросы других серверов.

Как при всём этом осуществляется регистрация в сети? Мы уже немного говорили о ключе Ed25519, связанным с каждым подтверждением доли. По сути, у нас есть одноранговое сообщение, которое передаётся в сеть, когда кто-то подтверждает долю. Кроме того, необходимо зарегистрировать и своё оборудование. Сообщение подписывается ключом Ed25519, в котором указывается порт и IP-адрес сервисного узла. Эта информация отправляется в сообщении, а другие серверы принимают её и сохраняют в локальной базе данных. Такой подход является более гибким, чем простое указание IP-адреса и порта в фактической транзакции регистрации, поскольку, если вы захотите изменить свой IP-адрес, вы всё равно сможете сделать это, обновив распространяемое сетевое сообщение.

Нам также нужна сетевая политика, ведь мы не хотим иметь в сети ресурсы, которые бы либо просто не работали, либо не обеспечивали должной производительности. В этом случае простейший подход, пожалуй, заключается в создании некоего централизованного сетевого узла, который бы наблюдал за производительностью каждого другого узла, а затем проводил в блокчейне транзакции, в которых бы говорилось: «Этот узел работает, а этот не работает». Это не лучший подход, потому что он, очевидно, централизован - по сути, такой сервис может заблокировать все сетевые узлы, если решит, что именно так нужно сделать.

В нашем случае всё контролируется самой сетью. Узлы объединяются в группу, а затем они исторически измеряют производительность других узлов в сети. Они запрашивают у них данные, пингуют их, чтобы узнать, находятся ли эти узлы в сети. А затем на уровне протокола также создаются группы узлов, которые большинством голосов решают, какие узлы, по их мнению, являются производительными, а какие нет. Таким образом, обеспечивается своего рода самоконтроль, основанный на подходе, при котором сеть сама решает, какие узлы она хочет отключить, а какие нет. И с точки зрения производительности сети такой подход имеет определённые преимущества.

Итак, что мы имеем? У нас есть базовое доказательство доли владения, у нас есть вознаграждения, и у нас есть устойчивая к атакам Сибиллы сеть, а также механизм удаления плохо работающей части архитектуры или узлов с низкой производительностью. И всё это построено на базе CryptoNote/Monero.

_[Реклама]_

_Вы любите кофе и Monero так же сильно, как и мы? А вам не хотелось бы начинать каждый свой день с чашки Gratuitas? Покупайте зёрна премиум-класса за Monero, и если вам придётся по душе их вкус, поделитесь цифровыми чаевыми напрямую с гватемальскими фермерами, которые позаботились о вас. Ваша поддержка способствует развитию нашего предприятия. Gratuitas и Monero._

_**Ки:**_ Итак, что мы можем сделать уже сейчас, в частности, на первом уровне, где точно можно сделать несколько интересных вещей. Мы можем реализовать функцию мгновенной финализации транзакций, реализовать контрольные точки, а также создавать другие приложения. И я немного расскажу об этом.

Итак, функция мгновенной финализации. По-моему, Dash была первой монетой, которая использовала её в системе Masternode. У них есть функция под названием InstantSend. Было бы очень здорово, если бы у нас получилось реализовать InstantSend поверх Monero. Это, собственно, и послужило отправной точкой. Итак, транзакции Monero первого уровня подтверждаются по истечении 10 блоков. Это скорее ограничение, связанное с кошельком. Но я попытался найти больше информации о самых значительных реорганизациях в блокчейне Monero. И, как мне кажется, я нашёл информацию, согласно которой самая значительная реорганизация составила до 20 блоков. Поэтому, когда пользователь принимает транзакцию, ему требуется какой-то допуск по безопасности. Если есть реальные транзакции такой длины, они могут подождать дольше, могут подождать меньше. Это зависит от их предпочтений. Но было бы неплохо, если бы мы могли завершать транзакции, не дожидаясь такого чрезмерного количества подтверждений. Чтобы совершая покупку в магазине, вы бы проводили транзакцию, а затем просто уходили, и продавец был бы уверен, что транзакция в конце концов подтвердится.

Так как же мы собираемся добиться мгновенной финализации? Мы объединяем созданные узлы, о которых я говорил ранее, в так называемые «кворумы», представляющие собой группы случайно выбранных сетевых узлов. Пользователи будут отправлять свои транзакции непосредственно в эти кворумы, и данная группа узлов, по сути, будет производить валидацию транзакции. Если транзакция гарантировано не была проведена дважды или не нарушает каких-либо других правил протокола, они подавляющим большинством подписывают эту транзакцию. То есть, если бы у нас было 20 узлов, то для подписания транзакции потребовалось бы 17 узлов из 20. Затем транзакция снова отправляется в пул памяти, но уже с этой специальной подписью. По сути, данная подпись означает, что при наличии созданного майнером блока с тем же образом ключа, а это уникальная часть криптовалютной транзакции, и если есть другой блок с таким же образом ключа, этот блок будет считаться недействительным и не будет принят в сеть.

Точно так же это делается и в Dash. Просто мы используем образы ключей, а они используют конкретные выходы. Так что это достаточно хорошо изученный подход. Но в случае с синхронизацией есть некоторые оговорки. Как правило, транзакции, которые отправляются в пул памяти, не являются объектами более высокого порядка, но мы синхронизируем эти транзакции так, как будто это своего рода блоки.

Всё это интегрировалось в Oxen, начиная с 2019 года. Сейчас с помощью Blink обрабатываются сотни тысяч транзакций. Этот метод используется по умолчанию, и среднее время, которое требуется для подписания транзакции кворумом, составляет примерно 1,5 секунды. Таким образом, включение транзакции в блокчейн происходит довольно быстро, и такая транзакция имеет больший вес с точки зрения консенсуса, чем новые блоки, которые будут созданы.

Ещё одна вещь, которую мы можем реализовать - контрольные точки. Этак тема этом, вероятно, немного чаще обсуждается сообществом Monero. На самом деле Monero уже размещает контрольные точки в блокчейне в новых версиях. Они не размещаются автоматически. Автоматической системы не существует. По сути, контрольная точка означает, что после её установки блокчейн не может быть реорганизован. Это действительно ограничивает возможность злоумышленникам, воспользовавшись атакой 51%, тайно заниматься майнингом в блокчейне, а затем отправить всё в сеть и отменить целую кучу транзакций, потому что если они сделают это и не установят контрольную точку, то их действия просто не будут признаны сетью действительными.

Идея очень схожа с идеей введения контрольных точек. Мы объединяем сервисные узлы в кворумы, они просматривают прошлые блоки и ставят соответствующую контрольную точку. А затем мы можем определить правила использования таких контрольных точек. И это похоже на то, как кворум большинством голосов подтверждает действительность конкретного блока. Так что, мы реализовали этот механизм  в Oxen, и это работает следующим образом: каждый четвёртый блок помечается контрольной точкой, и как только в блокчейне появляются две контрольные точки, его состояние становится финализированным, и вы уже не сможете изменить ничего, что было до этой точки. Поэтому даже если майнер тайно создаст цепочку блоков и попытается добавить её, она просто будет определена сетью как недействительная. И в большинстве случаев это означает, что мы достигаем полной финализации всех транзакций после восьми блоков. Их может быть и больше, в зависимости от того, сможет ли сеть прийти к консенсусу относительно размещения контрольной точки в блокчейне. У нас уже имеется 250 000 блоков с контрольной точкой. Системой уже был добавлен миллион блоков с тем же временем блокировки, что и у Monero, то есть около двух минут, так что, да, так делается уже несколько лет.

Далее, большинство из вас, вероятно, знает о приложениях, которые мы создаём на базе Oxen. Так что вы можете не только заниматься улучшениями первого уровня, но и создавать приложения второго уровня, при условии, что у вас есть этот созданный вами второй уровень. При этом вы можете задействовать децентрализованные свойства сети.

Очевидно, Session является самым значительным приложением из разработанных нами поверх Oxen. По сути, мы просто используем ресурсы, связанные с хранением данных и пропускной способностью сети. Сообщения маршрутизируются с использованием пропускной способности, а затем хранятся на серверах в течение определённого времени. Итак, это довольно простое приложение. Также важно отметить, что, несмотря на то, что вы можете хранить сообщения отдельно на сервисных узлах, такие узлы в любой момент могут выйти из сети или войти в сеть, но вы можете создавать уровни поверх второго, обеспечив тем самым дополнительное резервирование. У нас есть штука под названием Swarms, где сообщение реплицируется для множества узлов, и если один из этих узлов выходит из сети, вы, по крайней мере, не теряете своего сообщения. Существуют и другие копии.

Далее следует Lokinet. Если вы были на выступлении Алекса, то уже знаете, что это универсальный луковый маршрутизатор. Больше информации о нём можно найти в Интернете.

Теперь вернёмся к тому, как это связано с Monerotopia и миром Monero. Каким мог бы стать идеальный путь Monero к доказательству доли, и мог бы он быть таким же, как путь Oxen? В данном случае необходимо внести некоторые изменения на уровне консенсуса. Поддержка блокировки образа ключа на базовом уровне стала бы потрясающим вариантом, выделение части вознаграждения за блок относительно доли, а затем определение фиксированного требования к доле также было бы необходимым, равно как и изменение алгоритма выбора выходов, чтобы избежать выбора тех выходов, которые использовались для подтверждения доли владения.

Но это, как я и говорил ранее, пожалуй, не самый реалистичный путь к тому, чтобы в Monero был реализован алгоритм доказательства доли. По поводу доказательства доли в целом нет общего согласия. И да, это будет просто изменение консенсуса на уровне Monero, особенно это потребует экономических изменений, которые, скорее всего, будут отклонены. Так как же мы можем создать это без поддержки протокола? Знаю, это прозвучит спорно, но можно было бы использовать выходы с временной блокировкой для блокировки Monero на определённый период времени с последующим обнародованием ключа транзакции и дополнительного поля транзакции. По сути, это позволит вам сделать то, что мы делали в первой версии доказательства доли, и создать загрузочную сеть, использующую доказательство доли с протоколом XMR.

Можно было бы создать новый токен в другом блокчейне, либо задействовать другие конструкции. Не думаю, что они как-то были реализованы. Я знаю точно, что они пока что никак не реализованы в Monero, но существует такая конструкция под названием MARCT, RingCT с поддержкой множества активов, позволяющая заниматься майнингом токенов поверх Monero. Если бы что-то подобное существовало, то вы могли бы выплачивать вознаграждение тем, кто использует доказательство доли в Monero, токенами, созданными поверх Monero. Но, скорее всего, вам придётся использовать для этого внешний токен.

Тогда токены будут получать те пользователи, которые используют доказательство доли Monero с этими блокируемыми по времени выходами. А штрафы могут носить характер издержек, связанных с упущенными возможностями. Скажем, если вы пользователь размещает доказательство доли на 90 дней, а затем его инфраструктура выходит из строя, вы можете сказать: «Мы не станем выплачивать вознаграждение, и ваши Monero будут заблокированы на 45 оставшихся дней, что равносильно нашим издержкам, связанным с упущенными возможностями», и это будет иметь влияние на такого пользователя.

Но чтобы сделать что-то подобное, вероятно, понадобятся изменения на уровне протокола. И также не делайте этого, предварительно не посоветовавшись с исследователями Monero, поскольку, возможно, это очень сильно повлияет на приватность, которая мной в расчёт не принимается.

Итак, эта сеть позволяет создать сеть Monero, использующую доказательство доли владения. Вы сможете создавать «мотивированные» приложения, как это было сделано в случае с Session и LokiNet. Вы также сможете создавать сети, использующие алгоритм консенсуса, поверх Monero. Это пригодилось бы, например, для введения пробных контрольных точек. Вы сможете размещать собственные тестовые контрольные точки, а также произвести тестовое подтверждение мгновенной финализации. Не то чтобы для того, чтобы внесённые изменения работали, придётся что-то менять на уровне консенсуса, но это может стать неким стимулом, чтобы сказать: «Это действительно работает во вторичной сети, и, возможно, это то, что мы внедрим позже».

Итак, спасибо за внимание. Если вы хотите узнать больше о продуктах Oxen, здесь приводятся нужные ссылки. Вы также можете связаться со мной в Session, и встретиться здесь, на конференции. Также тут имеются ссылки на некоторые исследования в этой области. Я не так и много внимания уделил доказательству доли. Мне следовало бы рассказать о нём подробнее. Но существует белая книга, в которой описано, как всё это работает. И на этом я собираюсь поставить контрольную точку в нашей системе финализации. Так что да, спасибо за внимание.

_**Модератор:**_ У тебя есть время, чтобы ответить на несколько вопросов?

_**Ки:**_ Да, конечно.

_**Модератор:**_ У кого есть вопросы к Ки?

_**Вопрос:**_ Я уже задавал вопрос к вашему коллеге, но в вашей презентации, как я понял, упоминались удалённые атаки. И мне хотелось бы уточнить, используете ли вы скрытые суммы в своей сети или нет?

_**Ки:**_ В системе доказательства доли? Скрытые суммы?

_**Вопрос:**_ Да, это сеть со скрытыми суммами, верно?

_**Ки:**_ Да, да, да. Это...

_**Вопрос:**_ Да, но как быть с обязательствами? Для того создания обязательства приходится раскрывать суммы? Когда люди регистрируют свои монеты, те, кто создают доказательство доли...

_**Ки:**_ Да, эти суммы полностью пополнены.

_**Вопрос:**_ Мой вопрос: рассматриваете ли вы возможность создания системы, в которой те, кто генерирует доказательство доли, смогут регистрировать монеты, не раскрывая суммы, создавая при этом правильный консенсус, который позволить фиксировать всё это с помощью скрытых расчётов?

_**Ки:**_ Да, мы рассматривали этот вариант. В Oxen немного другая система. У нас фиксированное доказательство доли, так? 15 000 Oxen. Таким образом, когда кто-то генерирует доказательство доли, вы уже знаете, что он заблокирует определенное количество монет - 15 000 Oxen. То есть, скрывать эту сумму менее выгодно с точки зрения приватности, потому что она уже подразумевается при создании нового доказательства доли. Кроме того, часть генерируемого доказательства доли в Oxen довольно мала. Существует примерно 1800 узлов, которые делают это. И в целом, мы считаем, что они жертвуют своей приватностью в пользу этого сетевого сервиса и получают за это вознаграждение. Таким образом, они могут восстановить свою приватность после того, как закончат с доказательством доли и получат вознаграждение. Но пока их доказательство доли в силе, как нам кажется, это, пожалуй, не так и важно.

_**Вопрос:**_ Хорошо, спасибо. И последний вопрос: вы используете алгоритм консенсуса PBFT, верноравильно?

_**Ки:**_ Да, почти так.

_**Вопрос:**_ Вот почему у вас есть финализация.

_**Ки:**_ Да. Да.

_**Вопрос:**_ Я просто подумал, что это было бы очень здорово, потому что PBFT —отличная вещь, поскольку обеспечивает функцию финализации. Но было бы очень круто, если бы вы, ребята, смогли реализовать PBFT поверх скрытых сумм. Чтобы никому не приходилось раскрывать суммы, но при этом всё бы фиксировалось и работало.

_**Ки:**_ Да. Это было бы очень круто. Меня тоже интересует этот вопрос. Да.

_**Аудитория:**_ Спасибо.

_**Модератор:**_ Ещё вопросы? У нас есть онлайн-вопросы? Думаю, на этом всё. Поаплодируем Ки.

_**Ки:**_ Отлично. Спасибо всем.
